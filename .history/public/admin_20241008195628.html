<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Yodlr Admin Page</title>
    <link rel="stylesheet" href="css/admin.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        function loadUsers() {
          $.ajax({
            type: "GET",
            url: "http://localhost:3000/users",
            success: function (users) {
              var tableBody = $("#userTable tbody");
              tableBody.empty(); // clear the table before adding new rows

              users.forEach(function (user) {
                tableBody.append(
                  `<tr>
                      <td>${user.id}</td>
                      <td>${user.email}</td>
                      <td>${user.firstName}</td>
                      <td>${user.lastName}</td>
                      <td>${user.status}</td>
                      <td>
                          <button class="change-status" data-id="${userId}" data
                      <td><button class="delete" data-id="${user.id}">Delete</button></td>
                      </tr>`
                );
              });
            },
            error: function (err) {
              alert("Error fetching users: " + err.responseJSON.message);
            },
          });
        }

        loadUsers(); //loads users on page load

        //Handle status change
        $("#userTable").on("click", ".change-status", function () {
          var userId = $(this).data("id");
          var currentStatus = $(this).data("status");
          var newStatus = currentStatus === "active" ? "pending" : "active";

          $.ajax({
            type: "PUT",
            url: `http://localhost:3000/users/${userId}`,
            data: JSON.stringify({ status: newStatus }),
            contentType: "application/json",
            success: function () {
              alert("User status was updated to " + newStatus);
              loadUsers();
            },
            error: function (err) {
              alert("Error updating user status: " + err.responseJSON.message);
            },
          });
        });

        //Handle delete button click
        $("#userTable").on("click", ".delete", function () {
          var userId = $(this).data("id");
          $.ajax({
            type: "DELETE",
            url: `http://localhost:3000/users/${userId}`,
            success: function () {
              alert("User was deleted");
              loadUsers(); // reloads users after deletion was made
            },
            error: function (err) {
              alert("Error deleting user: " + err.responseJSON.message);
            },
          });
        });
      });
    </script>
  </head>
  <body>
    <h1>Yodlr Admin Page</h1>
    <table id="userTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Status</th>
          <th>Change Status</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p>
      <a href="signup.html">Registration Page</a>
    </p>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Yodlr Admin Page</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="css/admin.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        function loadUsers() {
          $.ajax({
            type: "GET",
            url: "http://localhost:3000/users",
            success: function (users) {
              var tableBody = $("#userTable tbody");
              tableBody.empty(); // clear the table before adding new rows

              users.forEach(function (user) {
                var statusButtons =
                  user.status === "active"
                    ? `<button class="set-pending" data-id="${user.id}">Set as Pending</button>`
                    : `<button class="set-active" data-id="${user.id}">Set as Active</button>`;

                tableBody.append(
                  `<tr>
                      <td>${user.id}</td>
                      <td>${user.email}</td>
                      <td>${user.firstName}</td>
                      <td>${user.lastName}</td>
                      <td>${user.status}</td>
                      <td>${statusButtons}
                      </td>
                      <td><button class="delete" data-id="${user.id}">Delete</button></td>
                      </tr>`
                );
              });
            },
            error: function (err) {
              alert("Error fetching users: " + err.responseJSON.message);
            },
          });
        }

        loadUsers(); //loads users on page load

        // Handle set as pending button click
        $("#userTable").on("click", ".set-pending", function () {
          var userId = $(this).data("id");
          $.ajax({
            type: "PUT",
            url: `http://localhost:3000/users/${userId}`,
            data: JSON.stringify({ id: userId, status: "pending" }), // Change status to 'pending'
            contentType: "application/json",
            success: function () {
              alert("User status updated to pending");
              loadUsers(); // Reload users after status change
            },
            error: function (err) {
              alert("Error updating user status: " + err.responseJSON.message);
            },
          });
        });

        // Handle set as active button click
        $("#userTable").on("click", ".set-active", function () {
          var userId = $(this).data("id");
          $.ajax({
            type: "PUT",
            url: `http://localhost:3000/users/${userId}`,
            data: JSON.stringify({ id: userId, status: "active" }), // Change status to 'active'
            contentType: "application/json",
            success: function () {
              alert("User status updated to active");
              loadUsers(); // Reload users after status change
            },
            error: function (err) {
              alert("Error updating user status: " + err.responseJSON.message);
            },
          });
        });

        //Handle delete button click
        $("#userTable").on("click", ".delete", function () {
          var userId = $(this).data("id");
          $.ajax({
            type: "DELETE",
            url: `http://localhost:3000/users/${userId}`,
            success: function () {
              alert("User was deleted");
              loadUsers(); // reloads users after deletion was made
            },
            error: function (err) {
              alert("Error deleting user: " + err.responseJSON.message);
            },
          });
        });
      });
    </script>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center">Yodlr Admin Page</h1>
      <table class="table table-striped table-bordered" id="userTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Status</th>
            <th>Change Status</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p>
        <a href="signup.html">Registration Page</a>
      </p>
    </div>
  </body>
</html>
